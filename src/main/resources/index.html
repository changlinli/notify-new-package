<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body>
<form action="/submitEmailAddress" method="post">
  <div>
    <label for="packageName">Package Name:</label>
    <input type="text" id="packageName" name="packages" placeholder="rust">
  </div>
  <div id="searchResults">
  </div>
  <div>
    <label for="emailAddress">Email Address:</label>
    <input type="email" id="emailAddress" name="emailAddress" placeholder="user@example.com">
  </div>
  <div>
    <button type="submit">Subscribe to package version updates!</button>
  </div>
</form>
</body>
<script>
    const input = document.getElementById('packageName');

    function createListElementFromSearchResult(resultElem) {
      var descriptionList = document.createElement('ul');
      var nameElement = document.createElement('li');
      nameElement.textContent = 'Name: ' + resultElem.name;
      var homepageElement = document.createElement('li');
      homepageElement.textContent = 'Homepage: ' + resultElem.homepage;
      var anityaIdElement = document.createElement('li');
      anityaIdElement.textContent = resultElem.anityaId;
      descriptionList.appendChild(nameElement);
      descriptionList.appendChild(homepageElement);
      descriptionList.appendChild(anityaIdElement);
      return descriptionList;
    }

    // This is not thread-safe! Which... I guess doesn't matter because JS is
    // single-threaded anyways
    function updateSearchResults(results) {
      var searchResultsDiv = document.getElementById('searchResults');
      if (results.length === 0) {
        searchResultsDiv.textContent = 'No results found!';
      } else {
        if (document.getElementById('searchResultsList')) {
          document.getElementById('searchResultsList').remove();
        }
        searchResultsDiv.textContent = '';
        var newList = document.createElement('ul');
        newList.id = "searchResultsList";
        results.forEach(function(element) {
          var listElement = document.createElement('li');
          console.log(element);
          var listElementContents = createListElementFromSearchResult(element);
          listElement.appendChild(listElementContents);
          newList.appendChild(listElement);
        });
        searchResultsDiv.appendChild(newList);
      }
    }

    function makeSearchRequest(searchString) {
      var httpRequest = new XMLHttpRequest();

      if (!httpRequest) {
        console.log("We failed to create an XMLHttpRequest!");
      }

      httpRequest.onreadystatechange = function () {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          console.log(JSON.parse(httpRequest.responseText));
          updateSearchResults(JSON.parse(httpRequest.responseText));
        }
      }
      httpRequest.open('GET', '/search?name=' + input.value);
      httpRequest.send();
    }

    function sendStringToSearch(event) {
      makeSearchRequest(input.value);
    }

    input.onkeyup = sendStringToSearch;
</script>
</html>
