<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body>
<div>
  <label for="packageName">Package Name:</label>
  <input type="text" id="packageName" name="packages" placeholder="rust">
</div>
<form action="/submitEmailAddress" method="post">
  <div id="packagesForSubscriptionFormElems">
  </div>
  <div id="searchResults">
  </div>
  <div>
    <label for="emailAddress">Email Address:</label>
    <input type="email" id="emailAddress" name="emailAddress" placeholder="user@example.com">
  </div>
  <div>
    <button type="submit">Submit your subscription preferences!</button>
  </div>
</form>
<ul id="packagesToSubscribeToDiv">
</ul>
<ul id="packagesToUnsubscribeFromDiv">
</ul>
</body>
<script>
    const input = document.getElementById('packageName');

    const formPackageSubscriptionElements = document.getElementById('packagesForSubscriptionFormElems');

    const packagesToSubscribeToHtmlElement = document.getElementById('packagesToSubscribeToDiv');

    const packagesToSubscribeTo = new Map();

    const packagesToUnsubscribeFrom = new Map();

    function createListElementFromSearchResult(resultElem) {
      const descriptionList = document.createElement('ul');
      const nameElement = document.createElement('li');
      nameElement.textContent = 'Name: ' + resultElem.name;
      const homepageElement = document.createElement('li');
      const homepageLink = document.createElement('a');
      homepageLink.textContent = resultElem.homepage;
      homepageLink.href = resultElem.homepage;
      homepageElement.textContent = 'Homepage: ';
      homepageElement.appendChild(homepageLink);
      const anityaIdElement = document.createElement('li');
      anityaIdElement.textContent = 'Anitya ID: ' + resultElem.anityaId;
      descriptionList.appendChild(nameElement);
      descriptionList.appendChild(homepageElement);
      descriptionList.appendChild(anityaIdElement);
      return descriptionList;
    }

    function createSubscriptionFormElement(anityaId) {
      const inputElement = document.createElement('input');
      inputElement.readOnly = true;
      inputElement.type = 'text';
      inputElement.name = 'packages';
      inputElement.value = anityaId;
      return inputElement;
    }

    function removeAllChildren(htmlElement) {
      while(htmlElement.firstChild) {
        htmlElement.removeChild(htmlElement.firstChild);
      }
    }

    function createListOfSubscriptions() {
      removeAllChildren(packagesToSubscribeToHtmlElement);
      removeAllChildren(formPackageSubscriptionElements);
      packagesToSubscribeTo.forEach(function(element) {
        const listElem = createListElementFromSearchResult(element);
        packagesToSubscribeToHtmlElement.appendChild(listElem);
        packagesToSubscribeToHtmlElement.appendChild(createRemoveSubscriptionButton(element));
        formPackageSubscriptionElements.appendChild(createSubscriptionFormElement(element.anityaId));
      });
    }

    function createRemoveSubscriptionButton(element) {
      const button = document.createElement('button');
      button.textContent = 'Remove';
      button.onclick = function() {removePackageFromToSubscribe(element);};
      return button;
    }

    function createRemoveUnsubscriptionButton() {
      const button = document.createElement('button');
      button.textContent = 'Remove';
      button.onclick = function() {
        packagesToUnsubscribeFrom.delete(htmlElement.anityaId);
        createListOfSubscriptions();
      };
      return button;
    }

    function removePackageFromToSubscribe(resultElem) {
      console.log(resultElem);
      console.log(packagesToSubscribeTo);
      console.log(packagesToSubscribeTo.delete(resultElem.anityaId));
      createListOfSubscriptions();
    }

    function addPackageToSubscribe(resultElem) {
      packagesToSubscribeTo.set(resultElem.anityaId, resultElem);
      createListOfSubscriptions();
    }

    function addPackageToUnsubscribe(resultElem) {
      packagesToUnsubscribeFrom.set(resultElem.anityaId, resultElem);
      createListOfSubscriptions();
    }

    function createSubscribeButton(resultElement) {
      const button = document.createElement('button');
      button.type = 'button';
      button.textContent = 'Subscribe to notifications about this package'
      button.onclick = function() {addPackageToSubscribe(resultElement);};
      return button;
    }

    function createUnsubscribeButton(resultElement) {
      const button = document.createElement('button');
      button.type = 'button';
      button.textContent = 'Unsubscribe from notifications about this package'
      button.onclick = function() {addPackageToUnsubscribe(resultElement);};
      return button;
    }

    // This is not thread-safe! Which... I guess doesn't matter because JS is
    // single-threaded anyways
    function updateSearchResults(results) {
      const searchResultsDiv = document.getElementById('searchResults');
      if (results.length === 0) {
        searchResultsDiv.textContent = 'No results found!';
      } else {
        if (document.getElementById('searchResultsList')) {
          document.getElementById('searchResultsList').remove();
        }
        searchResultsDiv.textContent = '';
        const newList = document.createElement('ul');
        newList.id = "searchResultsList";
        results.forEach(function(element) {
          const listElement = document.createElement('li');
          console.log(element);
          const listElementContents = createListElementFromSearchResult(element);
          listElement.appendChild(listElementContents);
          listElement.appendChild(createSubscribeButton(element));
          listElement.appendChild(createUnsubscribeButton(element));
          newList.appendChild(listElement);
        });
        searchResultsDiv.appendChild(newList);
      }
    }

    function makeSearchRequest(searchString) {
      const httpRequest = new XMLHttpRequest();

      if (!httpRequest) {
        console.log("We failed to create an XMLHttpRequest!");
      }

      httpRequest.onreadystatechange = function () {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          console.log(JSON.parse(httpRequest.responseText));
          updateSearchResults(JSON.parse(httpRequest.responseText));
        }
      }
      httpRequest.open('GET', '/search?name=' + input.value);
      httpRequest.send();
    }

    function sendStringToSearch(event) {
      makeSearchRequest(input.value);
    }

    input.onkeyup = sendStringToSearch;
</script>
</html>
